name: publish-cli

on:
  push:
    branches: [main]

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Auto-bump version on CLI changes
        id: bump
        run: |
          python - <<'PY'
          import re
          import subprocess
          from pathlib import Path
          from packaging.version import Version
          import json
          import urllib.request
          import os

          def run(cmd: str) -> str:
              return subprocess.check_output(cmd, shell=True, text=True).strip()

          last_author = run("git log -1 --pretty=%an")
          last_message = run("git log -1 --pretty=%s")
          if last_author == "github-actions[bot]" or "chore(cli): bump version" in last_message:
              print("Last commit is an auto-bump; skipping bump.")
              Path("bump.env").write_text("bumped=false\n", encoding="utf-8")
              raise SystemExit(0)

          changed = []
          event_path = os.environ.get("GITHUB_EVENT_PATH")
          if event_path and Path(event_path).exists():
              payload = json.loads(Path(event_path).read_text(encoding="utf-8"))
              for commit in payload.get("commits", []):
                  for key in ("added", "modified", "removed"):
                      changed.extend(commit.get(key, []))
          if not changed:
              before = os.environ.get("GITHUB_EVENT_BEFORE")
              if before and before != "0000000000000000000000000000000000000000":
                  diff = run(f"git diff --name-only {before} HEAD")
              else:
                  diff = run("git diff --name-only HEAD^ HEAD")
              changed = [line for line in diff.splitlines() if line]
          bump_paths = (
              "src/guardrails_cli/",
              "pyproject.toml",
              "README.md",
          )
          if not any(path.startswith(bump_paths) for path in changed):
              print("No CLI changes detected; skipping bump.")
              Path("bump.env").write_text("bumped=false\n", encoding="utf-8")
              raise SystemExit(0)

          pyproject = Path("pyproject.toml")
          text = pyproject.read_text(encoding="utf-8")
          match = re.search(r"^version\s*=\s*\"(\d+)\.(\d+)\.(\d+)\"", text, re.MULTILINE)
          if not match:
              raise SystemExit("Version not found in pyproject.toml")
          major, minor, patch = map(int, match.groups())
          local_version = Version(f"{major}.{minor}.{patch}")
          latest_version = local_version
          try:
              with urllib.request.urlopen("https://pypi.org/pypi/guardrails-cli/json", timeout=10) as resp:
                  data = json.loads(resp.read().decode("utf-8"))
                  latest = data.get("info", {}).get("version")
                  if latest:
                      latest_version = Version(latest)
          except Exception:
              pass
          base_version = latest_version if latest_version > local_version else local_version
          new_version = Version(f"{base_version.major}.{base_version.minor}.{base_version.micro + 1}")
          updated = re.sub(
              r"^version\s*=\s*\"(\d+)\.(\d+)\.(\d+)\"",
              f'version = "{new_version}"',
              text,
              flags=re.MULTILINE,
          )
          pyproject.write_text(updated, encoding="utf-8")

          run("git config user.name 'github-actions[bot]'")
          run("git config user.email '41898282+github-actions[bot]@users.noreply.github.com'")
          run("git add pyproject.toml")
          run(f"git commit -m 'chore(cli): bump version to {new_version}'")
          run("git push")
          Path("bump.env").write_text(f"bumped=true\nversion={new_version}\n", encoding="utf-8")
          PY

      - name: Load bump metadata
        id: bumpmeta
        run: |
          if [ -f bump.env ]; then
            cat bump.env >> $GITHUB_ENV
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install build packaging requests

      - name: Determine publish need
        id: version
        run: |
          python - <<'PY'
          import json
          import sys
          import urllib.request
          from pathlib import Path
          from packaging.version import Version
          from os import environ

          pyproject = Path("pyproject.toml").read_text(encoding="utf-8")
          version_line = next((line for line in pyproject.splitlines() if line.strip().startswith("version")), None)
          if not version_line:
            Path(environ["GITHUB_OUTPUT"]).write_text("publish=false\n", encoding="utf-8")
            sys.exit(0)
          version = version_line.split("=")[1].strip().strip('"')
          package = "guardrails-cli"

          try:
            with urllib.request.urlopen(f"https://pypi.org/pypi/{package}/json", timeout=10) as resp:
              data = json.loads(resp.read().decode("utf-8"))
              releases = data.get("releases", {})
              if version in releases:
                Path(environ["GITHUB_OUTPUT"]).write_text("publish=false\n", encoding="utf-8")
                print(f"Version {version} already on PyPI.")
                sys.exit(0)
          except Exception:
            pass

          Path(environ["GITHUB_OUTPUT"]).write_text("publish=true\n", encoding="utf-8")
          print(f"Publishing version {version}.")
          PY

      - name: Build package
        if: steps.version.outputs.publish == 'true'
        run: python -m build

      - name: Publish to PyPI
        if: steps.version.outputs.publish == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
